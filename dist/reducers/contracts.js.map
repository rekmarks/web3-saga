{"version":3,"sources":["../../src/reducers/contracts.js"],"names":["watchDeploySaga","deploySaga","initialState","types","Object","values","defaultContracts","reduce","acc","c","id","bytecode","NAMESPACE","name","contractName","artifact","errors","isDeploying","instances","sagas","ACTIONS","BEGIN_DEPLOYMENT","_test","actions","getClearErrorsAction","getBeginDeploymentAction","getDeploymentFailureAction","getDeploymentSuccessAction","fn","deployContract","prepareForDeployment","reducer","state","action","type","END_DEPLOYMENT","DEPLOYMENT_SUCCESS","data","DEPLOYMENT_FAILURE","concat","error","CLEAR_ERRORS","contractId","constructorParams","selectors","web3","contracts","ready","result","Error","provider","account","contractTypes","arrayParams","Array","isArray","keys","sort","a","b","paramOrder","map","key","value","instance","address","networkId"],"mappings":";;;;;;;;;;;;;;;;;;;;AAGA;;AAEA;;AACA;;AAEA;;AAUA;;AAEA;;AAKA;;;;0BA4KWA,e;;;0BASAC,U;;AAnLX;AAEA,IAAMC,YAAY,GAAG;AAEnBC,EAAAA,KAAK,EAAEC,MAAM,CAACC,MAAP,CAAcC,mBAAd,EAAgCC,MAAhC,CAAuC,UAACC,GAAD,EAAMC,CAAN,EAAY;AACxD,QAAMC,EAAE,GAAG,iBAAOD,CAAC,CAACE,QAAT,EAAmBC,gBAAnB,CAAX;AACAJ,IAAAA,GAAG,CAACE,EAAD,CAAH,GAAU;AACRA,MAAAA,EAAE,EAAEA,EADI;AAERG,MAAAA,IAAI,EAAEJ,CAAC,CAACK,YAFA;AAGRC,MAAAA,QAAQ,EAAEN,CAHF,CAGK;;AAHL,KAAV;AAKA,WAAOD,GAAP;AACD,GARM,EAQJ,EARI,CAFY;AAYnB;AACAQ,EAAAA,MAAM,EAAE,EAbW;AAenB;AACAC,EAAAA,WAAW,EAAE,KAhBM;AAkBnB;AACAC,EAAAA,SAAS,EAAE,CACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAXS,GAnBQ,CAiCnB;AACA;AACA;AAEA;AACA;AACA;;AAvCmB,CAArB;;AA0CA,IAAMC,KAAK,GAAG,CACb,0BAAYC,mBAAQC,gBAApB,EAAsCpB,UAAtC,CADa,CAAd;;AAIA,IAAMqB,KAAK,GAAG;AACZC,EAAAA,OAAO,EAAE;AACPC,IAAAA,oBAAoB,EAApBA,oBADO;AAEPC,IAAAA,wBAAwB,EAAxBA,wBAFO;AAGPC,IAAAA,0BAA0B,EAA1BA,0BAHO;AAIPC,IAAAA,0BAA0B,EAA1BA;AAJO,GADG;AAOZR,EAAAA,KAAK,EAAE;AACLlB,IAAAA,UAAU,EAAVA,UADK;AAELD,IAAAA,eAAe,EAAfA;AAFK,GAPK;AAWZ4B,EAAAA,EAAE,EAAE;AACFC,IAAAA,cAAc,EAAdA,cADE;AAEFC,IAAAA,oBAAoB,EAApBA;AAFE;AAXQ,CAAd;;;AAyBe,SAASC,OAAT,GAAgD;AAAA,MAA9BC,KAA8B,uEAAtB9B,YAAsB;AAAA,MAAR+B,MAAQ;;AAE7D,UAAQA,MAAM,CAACC,IAAf;AAEE,SAAKd,mBAAQC,gBAAb;AACE,6CACKW,KADL;AAEEf,QAAAA,WAAW,EAAE;AAFf;;AAKF,SAAKG,mBAAQe,cAAb;AACE,6CACKH,KADL;AAEEf,QAAAA,WAAW,EAAE;AAFf;;AAKF,SAAKG,mBAAQgB,kBAAb;AAEE,6CACKJ,KADL;AAGEd,QAAAA,SAAS,kCACJc,KAAK,CAACd,SADF,oCAGNe,MAAM,CAACvB,EAHD,kCAIFuB,MAAM,CAACI,IAJL;AAKL3B,UAAAA,EAAE,EAAEuB,MAAM,CAACvB,EALN,CAML;;AANK,YAHX;AAYEO,QAAAA,WAAW,EAAE;AAZf;;AAeF,SAAKG,mBAAQkB,kBAAb;AACE,6CACKN,KADL;AAEEhB,QAAAA,MAAM,EAAEgB,KAAK,CAAChB,MAAN,CAAauB,MAAb,CAAoBN,MAAM,CAACO,KAA3B,CAFV;AAGEvB,QAAAA,WAAW,EAAE;AAHf;;AAMF,SAAKG,mBAAQqB,YAAb;AACE,6CACKT,KADL;AAEEhB,QAAAA,MAAM,EAAE;AAFV;;AAKF;AACE,aAAOgB,KAAP;AA7CJ;AA+CD;AAED;;;;AAIA;;;;;;;;AAMA,SAASP,wBAAT,CAAmCiB,UAAnC,EAA+CC,iBAA/C,EAAkE;AAChE,SAAO;AACLT,IAAAA,IAAI,EAAEd,mBAAQC,gBADT;AAELqB,IAAAA,UAAU,EAAVA,UAFK;AAGLC,IAAAA,iBAAiB,EAAjBA;AAHK,GAAP;AAKD;;AAED,SAAShB,0BAAT,CAAqCjB,EAArC,EAAyC2B,IAAzC,EAA+C;AAC7C,SAAO;AACLH,IAAAA,IAAI,EAAEd,mBAAQgB,kBADT;AAEL1B,IAAAA,EAAE,EAAFA,EAFK;AAGL2B,IAAAA,IAAI,EAAJA;AAHK,GAAP;AAKD;;AAED,SAASX,0BAAT,CAAqCc,KAArC,EAA4C;AAC1C,SAAO;AACLN,IAAAA,IAAI,EAAEd,mBAAQkB,kBADT;AAELE,IAAAA,KAAK,EAALA;AAFK,GAAP;AAID;;AAED,SAAShB,oBAAT,GAAiC;AAC/B,SAAO;AACLU,IAAAA,IAAI,EAAEd,mBAAQqB;AADT,GAAP;AAGD;AAED;;;;AAIA;;;;;AAGA,SAAWzC,eAAX;AAAA;AAAA;AAAA;AAAA;AAAA;AACE,iBAAM,0BAAYoB,mBAAQC,gBAApB,EAAsCpB,UAAtC,CAAN;;AADF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAIA;;;;;;;AAKA,SAAWA,UAAX,CAAuBgC,MAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGe,iBAAM,qBAAOW,mBAAUC,IAAjB,CAAN;;AAHf;AAGQA,UAAAA,IAHR;AAAA;AAIoB,iBAAM,qBAAOD,mBAAUE,SAAjB,CAAN;;AAJpB;AAIQA,UAAAA,SAJR;AAMMC,UAAAA,KANN,GAMc,KANd;AAAA;AAOQA,UAAAA,KAAK,GAAGjB,oBAAoB,CAACe,IAAD,CAA5B;AAPR;AAAA;;AAAA;AAAA;AAAA;AAAA;AAQI,iBAAM,kBAAInB,0BAA0B,cAA9B,CAAN;;AARJ;AAAA,eAWMqB,KAXN;AAAA;AAAA;AAAA;;AAAA;AAAA;AAaqB,iBAAM,mBACnBlB,cADmB,EAEnBgB,IAFmB,EAGnBC,SAAS,CAAC3C,KAHS,EAInB8B,MAAM,CAACS,UAJY,EAKnBT,MAAM,CAACU,iBALY,CAAN;;AAbrB;AAaYK,UAAAA,MAbZ;AAAA;AAoBM,iBAAM,kBAAIrB,0BAA0B,CAAC,iBAAD,EAAWqB,MAAX,CAA9B,CAAN;;AApBN;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAsBM,iBAAM,kBAAItB,0BAA0B,cAA9B,CAAN;;AAtBN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA2BA;;;;AAIA;;;;;;;;;AAOA,SAASI,oBAAT,CAA+Be,IAA/B,EAAqC;AAEnC,MAAI,CAACA,IAAI,CAACE,KAAV,EAAiB;AACf,UAAM,IAAIE,KAAJ,CAAU,2BAAV,CAAN;AACD;;AACD,MAAI,CAACJ,IAAI,CAACK,QAAV,EAAoB;AAClB,UAAM,IAAID,KAAJ,CAAU,wBAAV,CAAN;AACD;;AACD,MAAI,CAACJ,IAAI,CAACM,OAAV,EAAmB;AACjB,UAAM,IAAIF,KAAJ,CAAU,uBAAV,CAAN;AACD;;AACD,SAAO,IAAP;AACD;AAED;;;;;;;;;;;;;SAWepB,c;;;;;;;4BAAf,iBACIgB,IADJ,EAEIO,aAFJ,EAGIV,UAHJ,EAIIC,iBAJJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBAQOS,aAAa,CAACV,UAAD,CARpB;AAAA;AAAA;AAAA;;AAAA,kBASU,IAAIO,KAAJ,CAAU,0BAA0BP,UAA1B,GAAuC,UAAjD,CATV;;AAAA;AAYE;AACA;AACA;AACIW,YAAAA,WAfN,GAeoB,EAfpB;;AAgBE,gBAAI,CAACC,KAAK,CAACC,OAAN,CAAcZ,iBAAd,CAAL,EAAuC;AACrC;AACAU,cAAAA,WAAW,GAAGjD,MAAM,CAACoD,IAAP,CAAYb,iBAAZ,EACXc,IADW,CACN,UAACC,CAAD,EAAIC,CAAJ,EAAU;AACd,uBAAOhB,iBAAiB,CAACe,CAAD,CAAjB,CAAqBE,UAArB,GACAjB,iBAAiB,CAACgB,CAAD,CAAjB,CAAqBC,UAD5B;AAED,eAJW,EAKXC,GALW,CAKP,UAAAC,GAAG;AAAA,uBAAInB,iBAAiB,CAACmB,GAAD,CAAjB,CAAuBC,KAA3B;AAAA,eALI,CAAd;AAMD,aARD,MAQO;AACLV,cAAAA,WAAW,GAAGV,iBAAd;AACD;;AAEK5B,YAAAA,QA5BR,GA4BmBqC,aAAa,CAACV,UAAD,CAAb,CAA0B3B,QA5B7C,EA8BE;AACA;;AA/BF;AAAA,mBAgCyB,sBACrBA,QADqB,EAErBsC,WAFqB,EAGrBR,IAAI,CAACK,QAHgB,EAIrBL,IAAI,CAACM,OAJgB,CAhCzB;;AAAA;AAgCQa,YAAAA,QAhCR;AAAA,8CAwCS;AACLA,cAAAA,QAAQ,EAAEA,QADL;AAELC,cAAAA,OAAO,EAAED,QAAQ,CAACC,OAFb;AAGLd,cAAAA,OAAO,EAAEN,IAAI,CAACM,OAHT;AAILjB,cAAAA,IAAI,EAAEnB,QAAQ,CAACD,YAJV;AAKL6B,cAAAA,iBAAiB,EAAEA,iBALd;AAMLuB,cAAAA,SAAS,EAAErB,IAAI,CAACqB;AANX,aAxCT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G","sourcesContent":["\n// package imports\n\nimport { put, takeLeading, call, select } from 'redux-saga/effects'\n\nimport uuidv4 from 'uuid/v4'\nimport uuidv5 from 'uuid/v5'\n\nimport {\n  contracts as defaultContracts, // all default contracts come from chain-end\n  deploy as _deploy,\n  // v2.0\n  // getInstance,\n  // callInstance,\n} from 'chain-end'\n\n// local imports\n\nimport { contracts as ACTIONS } from '../actions'\n\nimport selectors from '../selectors'\n\n// contract type uuids are created using the contract bytecode (see call below)\n// think of the resulting uuid as a hash of the contract artifact to help\n// prevent the addition of duplicate contracts\nimport { NAMESPACE } from '../utils'\n\n// import { getDisplayAddress } from '../utils' // eth address truncation\n\nconst initialState = {\n\n  types: Object.values(defaultContracts).reduce((acc, c) => {\n    const id = uuidv5(c.bytecode, NAMESPACE)\n    acc[id] = {\n      id: id,\n      name: c.contractName,\n      artifact: c, // Truffle compilation output\n    }\n    return acc\n  }, {}),\n\n  // error storage\n  errors: [],\n\n  // prevents further web3 calls if false\n  isDeploying: false,\n\n  // deployed contract instances\n  instances: {\n    // id: {\n    //   id,\n    //   truffleContract,\n    //   address,\n    //   account,\n    //   type,\n    //   constructorParams,\n    //   networkId,\n    //   dappTemplateIds,\n    //   templateNodeId,\n    // }\n  },\n\n  // v2.0\n  // // contract instance call storage\n  // callHistory: [],\n\n  // v3.0\n  // // used when deploying dapps\n  // deploymentQueue: null,\n}\n\nconst sagas = [\n takeLeading(ACTIONS.BEGIN_DEPLOYMENT, deploySaga),\n]\n\nconst _test = {\n  actions: {\n    getClearErrorsAction,\n    getBeginDeploymentAction,\n    getDeploymentFailureAction,\n    getDeploymentSuccessAction,\n  },\n  sagas: {\n    deploySaga,\n    watchDeploySaga,\n  },\n  fn: {\n    deployContract,\n    prepareForDeployment,\n  },\n}\n\nexport {\n  getBeginDeploymentAction as deployContract,\n  getClearErrorsAction as clearErrors,\n  initialState,\n  sagas,\n  _test,\n}\n\nexport default function reducer (state = initialState, action) {\n\n  switch (action.type) {\n\n    case ACTIONS.BEGIN_DEPLOYMENT:\n      return {\n        ...state,\n        isDeploying: true,\n      }\n\n    case ACTIONS.END_DEPLOYMENT:\n      return {\n        ...state,\n        isDeploying: false,\n      }\n\n    case ACTIONS.DEPLOYMENT_SUCCESS:\n\n      return {\n        ...state,\n\n        instances: {\n          ...state.instances,\n\n          [action.id]: {\n            ...action.data,\n            id: action.id,\n            // dappTemplateIds: action.data.dappTemplateIds || [],\n          },\n        },\n        isDeploying: false,\n      }\n\n    case ACTIONS.DEPLOYMENT_FAILURE:\n      return {\n        ...state,\n        errors: state.errors.concat(action.error),\n        isDeploying: false,\n      }\n\n    case ACTIONS.CLEAR_ERRORS:\n      return {\n        ...state,\n        errors: [],\n      }\n\n    default:\n      return state\n  }\n}\n\n/**\n * Synchronous action creators\n */\n\n/**\n * Initializes contract deployment.\n * @param {string} contractId the uuid of the contract to deploy\n * @param {array} constructorParams the parameters, in the order they must be\n * passed to the constructor, or an object\n */\nfunction getBeginDeploymentAction (contractId, constructorParams) {\n  return {\n    type: ACTIONS.BEGIN_DEPLOYMENT,\n    contractId,\n    constructorParams,\n  }\n}\n\nfunction getDeploymentSuccessAction (id, data) {\n  return {\n    type: ACTIONS.DEPLOYMENT_SUCCESS,\n    id,\n    data,\n  }\n}\n\nfunction getDeploymentFailureAction (error) {\n  return {\n    type: ACTIONS.DEPLOYMENT_FAILURE,\n    error,\n  }\n}\n\nfunction getClearErrorsAction () {\n  return {\n    type: ACTIONS.CLEAR_ERRORS,\n  }\n}\n\n/**\n * Sagas\n */\n\n/**\n * Watcher for deploySaga.\n */\nfunction * watchDeploySaga () {\n  yield takeLeading(ACTIONS.BEGIN_DEPLOYMENT, deploySaga)\n}\n\n/**\n * Attempts to deploy the given contract by calling its constructor with the\n * given parameters. Handles success and failure.\n * @param {object} action the action initializing the deployment procedure\n */\nfunction * deploySaga (action) {\n\n  // get necessary substate\n  const web3 = yield select(selectors.web3)\n  const contracts = yield select(selectors.contracts)\n\n  let ready = false\n  try { ready = prepareForDeployment(web3) } catch (error) {\n    yield put(getDeploymentFailureAction(error))\n  }\n\n  if (ready) {\n    try {\n      const result = yield call(\n        deployContract,\n        web3,\n        contracts.types,\n        action.contractId,\n        action.constructorParams\n      )\n      yield put(getDeploymentSuccessAction(uuidv4(), result))\n    } catch (error) {\n      yield put(getDeploymentFailureAction(error))\n    }\n  }\n}\n\n/**\n * Internal helpers\n */\n\n/**\n * Validates pre-deployment state. Throws error if validation fails.\n * Returns true otherwise.\n *\n * @param {object} web3 redux web3 substate\n * @return {bool} true if validation successful, else throws\n */\nfunction prepareForDeployment (web3) {\n\n  if (!web3.ready) {\n    throw new Error('Reducer \"web3\" not ready.')\n  }\n  if (!web3.provider) {\n    throw new Error('Missing web3 provider.')\n  }\n  if (!web3.account) {\n    throw new Error('Missing web3 account.')\n  }\n  return true\n}\n\n/**\n * Helper performing actual deployment work.\n * Validates that the contract's artifact exists and that the web3 call is\n * successful.\n *\n * @param {object} web3 redux web3 substate\n * @param {object} contractTypes contract types from state\n * @param {string} contractId name of contract to deploy\n * @param {array} constructorParams constructor parameters\n * @return {object} deployment data if successful, throws otherwise\n */\nasync function deployContract (\n    web3,\n    contractTypes,\n    contractId,\n    constructorParams,\n  ) {\n\n  // validation\n  if (!contractTypes[contractId]) {\n    throw new Error('No contract with id \"' + contractId + '\" found.')\n  }\n\n  // TODO: actually expect only arrays for this argument\n  // and move this conversion higher up the call chain\n  // (do form an object as below in the React component)\n  let arrayParams = []\n  if (!Array.isArray(constructorParams)) {\n    // convert object of params with data to array of param values\n    arrayParams = Object.keys(constructorParams)\n      .sort((a, b) => {\n        return constructorParams[a].paramOrder -\n               constructorParams[b].paramOrder\n      })\n      .map(key => constructorParams[key].value)\n  } else {\n    arrayParams = constructorParams\n  }\n\n  const artifact = contractTypes[contractId].artifact\n\n  // actual web3 call happens in here\n  // this may throw and that's fine\n  const instance = await _deploy(\n    artifact,\n    arrayParams,\n    web3.provider,\n    web3.account\n  )\n\n  // success, return deployment data\n  return {\n    instance: instance,\n    address: instance.address,\n    account: web3.account,\n    type: artifact.contractName,\n    constructorParams: constructorParams,\n    networkId: web3.networkId,\n  }\n}\n"],"file":"contracts.js"}